---
title: "COVID-19 Situation Report"
author:  "[David Azizi](https://unlikelyvolcano.com)"
output:
  html_document:
    toc: true
    toc_float: true
    #toc_depth: 3
    css: bootstrap.css
    highlight: tango
    fig_height: 7
---
```{r setup, include=FALSE}
library(knitr)
library(purrr)
library(ggplot2)
library(leaflet)
library(rgdal)
library(rgeos)
library(kableExtra)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)

options(scipen = 20)

theme_dark <- theme(
    line = element_line(colour = "white"),
    rect = element_rect(fill = "#060606"),
    text = element_text(color = "white"),
    title = element_text(color = "white"),
    plot.background = element_rect(fill = "#060606", color = NA),
    panel.background = element_rect(fill = "#060606", color = NA),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    legend.background = element_rect(fill = "#060606"),
    legend.title = element_blank(),
    axis.ticks.x = element_line(colour = "white"),
    axis.ticks.y = element_line(colour = "white"),
    axis.text = element_text(color = "white")
  )

ts_confirmed <-
  read.csv(
    "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",
    stringsAsFactors = F
  )

ts_deaths <-
  read.csv(
    "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv",
    stringsAsFactors = F
  )


update_date <- format.Date(Sys.Date(), "%d %B %Y")
daily_url <-
  sprintf(
    "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/%s.csv",
    format.Date(Sys.Date(), "%m-%d-%Y")
  )
if (!RCurl::url.exists(daily_url)) {
  daily_url <-
    sprintf(
      "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/%s.csv",
      format.Date(Sys.Date() - 1, "%m-%d-%Y")
    )
  update_date <- format.Date(Sys.Date() - 1, "%d %B %Y")
}

daily_update <- read.csv(daily_url, stringsAsFactors = F)

us_current <- read.csv("https://covidtracking.com/api/us.csv", stringsAsFactors = F)
us_testing <- read.csv("https://covidtracking.com/api/us/daily.csv", stringsAsFactors = F)
state_current <- read.csv("https://covidtracking.com/api/states.csv", stringsAsFactors = F)
state_testing <- read.csv("https://covidtracking.com/api/states/daily.csv", stringsAsFactors = F)
```

```{r us, include=FALSE}
us_ts <-
  data.frame(
    date = as.Date(names(ts_confirmed)[-(1:4)], format = "X%m.%e.%y"),
    cases = colSums(ts_confirmed[ts_confirmed$Country.Region %in% "US" , -(1:4)], na.rm = T),
    deaths = colSums(ts_deaths[ts_deaths$Country.Region %in% "US" , -(1:4)], na.rm = T)
  )
us_daily <- daily_update[daily_update$Country_Region %in% "US",]
us_testing$date <- as.Date(strptime(us_testing$date, format = "%Y%m%d"))
state_testing$date <- as.Date(strptime(state_testing$date, format = "%Y%m%d"))

us_mappable <- us_daily[!duplicated(us_daily$FIPS),]
us_mappable$FIPS <- sprintf("%05d", us_mappable$FIPS)
us_map <- readRDS("us_counties.RDS")
us_map <- merge(us_map, us_mappable, by.x = "GEOID", by.y = "FIPS")
rm(us_mappable)

state_map <- readRDS("us_states.RDS")
state_map_testing <- merge(state_map, state_current, by.x = "STUSPS", by.y = "state")
state_testing <-
  merge(
    state_testing,
    state_map@data,
    by.x = "state",
    by.y = "STUSPS",
    all.x = T
  )

us_new_cases <- us_ts$cases[-1] - us_ts$cases[-nrow(us_ts)]
us_new_deaths <- us_ts$deaths[-1] - us_ts$deaths[-nrow(us_ts)]
us_by_day <- us_ts$cases[-1] / us_ts$cases[-nrow(us_ts)]
us_by_day_d <- us_ts$deaths[-1] / us_ts$deaths[-nrow(us_ts)]
us_growth_rate <- us_new_cases[-1] / us_new_cases[-length(us_new_cases)]
us_growth_data <- data.frame(
  date = us_ts$date[-(1:2)],
  cases = us_ts$cases[-(1:2)],
  deaths = us_ts$deaths[-(1:2)],
  change_cases = us_by_day[-1],
  change_deaths = us_by_day_d[-1],
  new_cases = us_new_cases[-1],
  new_deaths = us_new_deaths[-1],
  change_new = us_growth_rate
)
rm(us_new_cases, us_new_deaths, us_by_day, us_by_day_d, us_growth_rate)
us_growth_data$change_new[is.infinite(us_growth_data$change_new)] <- 0
us_growth_data$change_new[is.nan(us_growth_data$change_new)] <- 0
```

```{r world, include=FALSE}
world_ts <-
  data.frame(
    date = as.Date(names(ts_confirmed), format = "X%m.%e.%y")[-(1:4)],
    cases = colSums(ts_confirmed[, -(1:4)], na.rm = T),
    deaths = colSums(ts_deaths[, -(1:4)], na.rm = T)
  )

wrld_new_cases <-
  world_ts$cases[-1] - world_ts$cases[-nrow(world_ts)]
wrld_new_deaths <-
  world_ts$deaths[-1] - world_ts$deaths[-nrow(world_ts)]
wrld_by_day <-
  world_ts$cases[-1] / world_ts$cases[-nrow(world_ts)]
wrld_by_day_d <-
  world_ts$deaths[-1] / world_ts$deaths[-nrow(world_ts)]
wrld_growth_rate <- wrld_new_cases[-1] / wrld_new_cases[-length(wrld_new_cases)]
wrld_growth_data <- data.frame(
  date = world_ts$date[-(1:2)],
  cases = world_ts$cases[-(1:2)],
  deaths = world_ts$deaths[-(1:2)],
  change_cases = wrld_by_day[-1],
  change_deaths = wrld_by_day_d[-1],
  new_cases = wrld_new_cases[-1],
  new_deaths = wrld_new_deaths[-1],
  change_new = wrld_growth_rate
)
rm(wrld_new_cases, wrld_new_deaths, wrld_by_day, wrld_growth_rate)
wrld_growth_data$change_new[is.infinite(us_growth_data$change_new)] <- 0
wrld_growth_data$change_new[is.nan(us_growth_data$change_new)] <- 0


wrld_confirmed <- sum(daily_update$Confirmed)
wrld_recovered <- sum(daily_update$Recovered)
wrld_deaths <- sum(daily_update$Deaths)
wrld_active <- wrld_confirmed - wrld_recovered - wrld_deaths

wrld_cases <-
  data.frame(
    id = rep("cases", 3),
    cases = c(wrld_active, wrld_recovered, wrld_deaths),
    type = factor(
      1:3,
      levels = 1:3,
      labels = c("active", "recovered", "deaths")
    ),
    stringsAsFactors = F
  )
```

This report was last updated on `r format(Sys.time(), "%d %B %Y at %H:%M")` with daily totals from `r update_date`.

Data collected by [JHU CSSE](https://systems.jhu.edu/research/public-health/ncov/) and [The COVID Tracking Project](https://covidtracking.com/).

<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101237072);</script>
<script async src="//static.getclicky.com/js"></script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101237072ns.gif" /></p></noscript>

# Overview {.tabset .tabset-fade .tabset-pills}
## United States
```{r us:overview}
us_over <-
  us_current[, c("positive", "negative", "total", "hospitalized", "death")]
us_over[1,] <- vapply(us_over[1,], prettyNum, "chr", big.mark = ",")
kable(
  us_over,
  col.names = c("Cases", "Negative Tests", "Total Tests", "Hospitalized", "Deaths"),
  row.names = F,
  align = "ccccc",
  digits = 3
) %>%
  kable_styling() %>%
  row_spec(1, bold = T) %>%
  column_spec(1, color = "darkorange") %>%
  column_spec(2, color = "seagreen") %>%
  column_spec(3, color = "royalblue") %>%
  column_spec(5, color = "firebrick")

```

## Global
```{r world:overview}

world_over <- t(c(wrld_confirmed, wrld_active, wrld_recovered, wrld_deaths))
world_over[1,] <- vapply(world_over[1,], prettyNum, "chr", big.mark = ",")
kable(
  world_over,
  col.names = c("Cases", "Active", "Recovered", "Deaths"),
  row.names = F,
  align = "ccccc",
  digits = 3
) %>%
  kable_styling() %>%
  row_spec(1, bold = T) %>%
  column_spec(1, color = "darkorange") %>%
  column_spec(4, color = "firebrick")

```

# Case Map {.tabset .tabset-fade .tabset-pills}
## United States
```{r us:map, fig.height=4}
dmn_confirmed <-
  c(min(log(us_map$Confirmed[us_map$Confirmed > 0]), na.rm = T),
    max(log(us_map$Confirmed[us_map$Confirmed > 0]), na.rm = T))
pal_confirmed <-
  colorNumeric(palette = "YlOrRd",
               domain = dmn_confirmed,
               na.color = "white")

dmn_positive <-
  c(min(log(state_map_testing$positive[state_map_testing$positive > 0]), na.rm = T),
    max(log(state_map_testing$positive[state_map_testing$positive > 0]), na.rm = T))
pal_positive <-
  colorNumeric(palette = "YlOrRd",
               domain = dmn_positive,
               na.color = "white")

dmn_total <-
  c(min(log(state_map_testing$total[state_map_testing$total > 0]), na.rm = T),
    max(log(state_map_testing$total[state_map_testing$total > 0]), na.rm = T))
pal_total <-
  colorNumeric(palette = "YlOrRd",
               domain = dmn_total,
               na.color = "white")


lab_counties <- paste0(
  "<strong>",
  us_map$Admin2,
  ifelse(us_map$Admin2 == "", "", ", "),
  us_map$Province_State,
  "</strong><br>",
  prettyNum(us_map$Confirmed , big.mark = ","),
  " cases<br>",
  prettyNum(us_map$Deaths, big.mark = ","),
  " deaths"
) %>%
  lapply(htmltools::HTML)

lab_states <- paste0(
  "<strong>",
  state_map_testing$NAME,
  "</strong><br>",
  prettyNum(state_map_testing$total, big.mark = ","),
  " tests<br>",
    prettyNum(state_map_testing$positive, big.mark = ","),
  " positive<br>",
  prettyNum(state_map_testing$negative, big.mark = ","),
  " negative"
) %>%
  lapply(htmltools::HTML)

lab_circle <- paste0(
  "<strong>",
  us_daily$Admin2,
  ifelse(us_daily$Admin2 == "", "", ", "),
  us_daily$Province_State,
  "</strong><br>",
  prettyNum(us_daily$Confirmed , big.mark = ","),
  " cases<br>",
  prettyNum(us_daily$Deaths, big.mark = ","),
  " deaths"
) %>%
  lapply(htmltools::HTML)

leaflet(us_map) %>%
  addProviderTiles(providers$Stamen.Toner) %>%
  addPolygons(
    fillColor = ~ pal_confirmed(log(Confirmed)),
    weight = 0.5,
    opacity = 1,
    color = "black",
    fillOpacity = 1,
    smoothFactor = 0.5,
    highlight = highlightOptions(
      weight = 3,
      color = "black",
      bringToFront = T,
      sendToBack = T
    ),
    label = lab_counties,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    group = "Counties"
  ) %>%
  addPolygons(
    data = state_map_testing,
    fillColor = ~ pal_positive(log(positive)),
    weight = 0.5,
    opacity = 1,
    color = "black",
    fillOpacity = 1,
    smoothFactor = 0.5,
    highlight = highlightOptions(
      weight = 3,
      color = "black",
      bringToFront = T,
      sendToBack = T
    ),
    label = lab_states,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    group = "States: Cases"
  ) %>%
  addPolygons(
    data = state_map_testing,
    fillColor = ~ pal_total(log(total)),
    weight = 0.5,
    opacity = 1,
    color = "black",
    fillOpacity = 1,
    smoothFactor = 0.5,
    highlight = highlightOptions(
      weight = 3,
      color = "black",
      bringToFront = T,
      sendToBack = T
    ),
    label = lab_states,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    group = "States: Tests"
  ) %>%
  addCircleMarkers(
    lng = us_daily$Long_,
    lat = us_daily$Lat,
    label = lab_circle,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    radius = log(us_daily$Confirmed),
    weight = 10,
    fillColor = "red",
    stroke = F,
    group = "Markers"
  ) %>%
  addLayersControl(
    baseGroups = c("Counties", "States: Cases", "States: Tests", "Markers"),
    position = "bottomleft",
    options = layersControlOptions(collapsed = F, autoZIndex = T)
  )  %>%
  setView(lat =  39.8333333,
          lng = -98.585522,
          zoom = 4)
```

## Global
```{r world:map, fig.height=4}
lab <- paste0(
  "<strong>",
  daily_update$Country_Region,
  ifelse(daily_update$Province_State == "", "", ": "),
  daily_update$Admin2,
  ifelse(daily_update$Admin2 == "", "", ", "),
  daily_update$Province_State,
  "</strong><br>",
  prettyNum(daily_update$Confirmed , big.mark = ","),
  " cases<br>",
  prettyNum(daily_update$Deaths, big.mark = ","),
  " deaths"
) %>%
  lapply(htmltools::HTML)

leaflet(daily_update) %>%
  addProviderTiles(providers$Stamen.Toner) %>%
  addCircleMarkers(
    lng = daily_update$Long_,
    lat = daily_update$Lat,
    label = lab,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    radius = log(daily_update$Confirmed),
    weight = 10,
    fillColor = "red",
    stroke = F
  )
```

# Cumulative Tests {.tabset .tabset-fade .tabset-pills}
## United States
```{r us:testing}
ggplot(us_testing, aes(x = date, y = total)) +
  geom_point(color = "darkorange", aes(y = positive)) +
  geom_line(color = "darkorange", aes(y = positive)) +
  geom_point(color = "seagreen", aes(y = negative)) +
  geom_line(color = "seagreen", aes(y = negative)) +
  geom_point(color = "royalblue") +
  geom_line(color = "royalblue") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(name = "Tests", n.breaks = 11, trans = "log10") +
  theme_dark
```

## By State
```{r state:testing, fig.show="animate", ffmpeg.format="gif", dev="jpeg"}
state_ts <- list()
state_names <- c()
for (i in unique(state_testing$state)) {
  state_ts[[i]] <- state_testing[state_testing$state == i, ]
  state_names <-
    c(state_names, unique(state_testing[state_testing$state == i, "NAME"]))
}
plots <- map2(
  state_ts,
  state_names,
  ~ ggplot(.x, aes(x = date, y = total)) +
    geom_point(color = "darkorange", aes(y = positive)) +
    geom_line(color = "darkorange", aes(y = positive)) +
    geom_point(color = "seagreen", aes(y = negative)) +
    geom_line(color = "seagreen", aes(y = negative)) +
    geom_point(color = "royalblue") +
    geom_line(color = "royalblue") +
    ggtitle(.y) +
    scale_x_date(
      name = "Date",
      date_breaks = "1 week",
      date_labels = "%b %e",
      limits = c(min(state_testing$date), NA)
    ) +
    scale_y_continuous(
      name = "Tests",
      n.breaks = 11,
      trans = "log10",
      limits = c(1, max(state_testing$total))
    ) +
    theme_dark
)
walk(plots, print)
```

# Cumulative Cases 
## Linear Scale {.tabset .tabset-fade .tabset-pills}
### United States
```{r us:total}
ggplot(us_ts, aes(x = date, y = cases)) +
  #geom_smooth(method = "loess", formula = y ~ x, color = "white") +
  geom_point(color = "firebrick", aes(y = 20 * deaths)) +
  geom_line(color = "firebrick", aes(y = 20 * deaths)) +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    name = "Cases",
    n.breaks = 11,
    sec.axis = sec_axis(~ . / 20, name = "Deaths")
  ) +
  theme_dark
```

### Global
```{r world:total}
ggplot(world_ts, aes(x = date, y = cases)) +
  #geom_smooth(method = "loess", formula = y ~ x, color = "white") +
  geom_point(color = "firebrick", aes(y = 20 * deaths)) +
  geom_line(color = "firebrick", aes(y = 20 * deaths)) +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    name = "Cases",
    n.breaks = 11,
    sec.axis = sec_axis( ~ . / 20, name = "Deaths")
  ) +
  theme_dark
```

## Log Scale {.tabset .tabset-fade .tabset-pills}

### United States
```{r us:logged}
ggplot(us_ts, aes(x = date, y = cases)) +
  geom_smooth(method = "lm", formula = y ~ x, color =  "darkgray") +
  geom_smooth(
    data = subset(us_ts, us_ts$date > "2020-02-29"),
    aes(x = date, y = cases),
    method = "lm",
    formula = y ~ x,
    color = "darkgrey",
    fullrange = T
  ) +
  geom_point(color = "firebrick", aes(y = deaths)) +
  geom_line(color = "firebrick", aes(y = deaths)) +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    name = "Cases",
    n.breaks = 11,
    trans = "log10",
    limits = c(0.3, NA),
    sec.axis = dup_axis( ~ ., name = "Deaths")
  ) +
  theme_dark
```

### Global
```{r world:logged}
ggplot(world_ts, aes(x = date, y = cases)) +
  geom_smooth(method = "lm", formula = y ~ x, color =  "darkgray") +
  geom_point(color = "firebrick", aes(y = deaths)) +
  geom_line(color = "firebrick", aes(y = deaths)) +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    name = "Cases",
    n.breaks = 11,
    trans = "log10",
    sec.axis = dup_axis( ~ ., name = "Deaths")
  ) +
  theme_dark
```

# Growth Rate
## New Cases by Day {.tabset .tabset-fade .tabset-pills}
### United States
```{r us:newcases}
ggplot(us_growth_data, aes(x = date, y = new_cases)) +
  geom_smooth(method = "loess",
              formula = y ~ x,
              color = "darkgray") +
  geom_point(color = "firebrick", aes(y = new_deaths)) +
  geom_line(color = "firebrick", aes(y = new_deaths)) +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    "New Cases",
    n.breaks = 11,
    trans = "log10",
    sec.axis = dup_axis(name = "Deaths")
  ) +
  theme_dark
```

### Global
```{r world:newcases}
ggplot(wrld_growth_data, aes(x = date, y = new_cases)) +
  geom_smooth(method = "loess",
              formula = y ~ x,
              color = "darkgray") +
  geom_point(color = "firebrick", aes(y = new_deaths)) +
  geom_line(color = "firebrick", aes(y = new_deaths)) +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    "New Cases",
    n.breaks = 11,
    trans = "log10",
    sec.axis = dup_axis(name = "Deaths")
  ) +
  #ggtitle("New Cases by Day on Earth") +
  theme_dark
```

## Rate of Change in New Cases {.tabset .tabset-fade .tabset-pills}
### United States
```{r us:growth}
ggplot(us_growth_data, aes(x = date, y = change_new)) +
  geom_hline(yintercept = 1,
             color = "white",
             linetype = "dashed") +
  geom_smooth(method = "loess",
              formula = y ~ x,
              color = "darkgray") +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous("∂ New Cases", n.breaks = 11, limits = c(-1, 5)) +
  theme_dark
```

### Global
```{r world:growth}
ggplot(wrld_growth_data, aes(x = date, y = change_new)) +
  geom_hline(yintercept = 1,
             color = "white",
             linetype = "dashed") +
  geom_smooth(method = "loess",
              formula = y ~ x,
              color = "darkgray") +
  geom_point(color = "darkorange") +
  geom_line(color = "darkorange") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous("∂ New Cases", n.breaks = 11, limits = c(-1, 6)) +
  theme_dark
```

# Table {.tabset .tabset-fade .tabset-pills}
## United States
```{r us:table}
out <- us_growth_data[us_growth_data$date > "2020-02-29",]
out$cases <- prettyNum(out$cases, big.mark = ",")
out$new_cases <- prettyNum(out$new_cases, big.mark = ",")
out$deaths <- prettyNum(out$deaths, big.mark = ",")
out$new_deaths <- prettyNum(out$new_deaths, big.mark = ",")
kable(
  out,
  col.names = c(
    "Date",
    "Cases",
    "Deaths",
    "∂ Cases",
    "∂ Deaths",
    "New Cases",
    "New Deaths",
    "∂ New Cases"
  ),
  row.names = F,
  align = "lllll",
  digits = 3
) %>%
  kable_styling(bootstrap_options = c("hover")) %>%
  column_spec(1, bold = T)
```

## Global
```{r world:table}
out <- wrld_growth_data[wrld_growth_data$date > "2020-02-29",]
out$cases <- prettyNum(out$cases, big.mark = ",")
out$new_cases <- prettyNum(out$new_cases, big.mark = ",")
out$deaths <- prettyNum(out$deaths, big.mark = ",")
out$new_deaths <- prettyNum(out$new_deaths, big.mark = ",")
kable(
  out,
  col.names = c(
    "Date",
    "Cases",
    "Deaths",
    "∂ Cases",
    "∂ Deaths",
    "New Cases",
    "New Deaths",
    "∂ New Cases"
  ),
  row.names = F,
  align = "lllll",
  digits = 3
) %>%
  kable_styling(bootstrap_options = c("hover")) %>%
  column_spec(1, bold = T)
```

