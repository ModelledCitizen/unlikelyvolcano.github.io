---
title: "COVID-19 Situation Report"
author:  "[UnlikelyVolcano (David Azizi)](https://unlikelyvolcano.com)"
output:
  html_document:
    toc: true
    toc_float: true
    #toc_depth: 3
    css: bootstrap.css
    highlight: tango
---
```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
library(leaflet)
library(rgdal)
library(rgeos)
library(kableExtra)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%"
)

options(sciepen = 20)

theme_dark <- theme(
    line = element_line(colour = "white"),
    rect = element_rect(fill = "#060606"),
    text = element_text(color = "white"),
    title = element_text(color = "white"),
    plot.background = element_rect(fill = "#060606", color = NA),
    panel.background = element_rect(fill = "#060606", color = NA),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    legend.background = element_rect(fill = "#060606"),
    legend.title = element_blank(),
    axis.ticks.x = element_line(colour = "white"),
    axis.ticks.y = element_line(colour = "white"),
    axis.text = element_text(color = "white")
  )

ts_confirmed <-
  read.csv(
    "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",
    stringsAsFactors = F
  )

ts_deaths <-
  read.csv(
    "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv",
    stringsAsFactors = F
  )

daily_update <-
  read.csv(
    sprintf(
      "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/%s.csv",
      format.Date(Sys.Date(), "%m-%d-%Y")
    ),
    stringsAsFactors = F
  )
```

```{r us, include=FALSE}
us_ts <-
  data.frame(
    date = as.Date(names(ts_confirmed)[-(1:4)], format = "X%m.%e.%y"),
    cases = colSums(ts_confirmed[ts_confirmed$Country.Region == "US" , -(1:4)], na.rm = T),
    deaths = colSums(ts_deaths[ts_deaths$Country.Region == "US" , -(1:4)], na.rm = T)
  )
us_daily <- daily_update[daily_update$Country_Region == "US",]

us_mappable <- us_daily[!duplicated(us_daily$FIPS),]
us_map <- readRDS("smallercounties.RDS")
us_map <- merge(us_map, us_mappable, by.x = "GEOID", by.y = "FIPS")
rm(us_mappable)

us_new_cases <- us_ts$cases[-1] - us_ts$cases[-nrow(us_ts)]
us_by_day <- us_ts$cases[-1] / us_ts$cases[-nrow(us_ts)]
us_growth_rate <- us_new_cases[-1] / us_new_cases[-length(us_new_cases)]
us_growth_data <- data.frame(
  date = us_ts$date[-(1:2)],
  cases = us_ts$cases[-(1:2)],
  change_cases = us_by_day[-1],
  new_cases = us_new_cases[-1],
  change_new = us_growth_rate
)
rm(us_new_cases, us_by_day, us_growth_rate)
us_growth_data$change_new[is.infinite(us_growth_data$change_new)] <- 0
us_growth_data$change_new[is.nan(us_growth_data$change_new)] <- 0

us_confirmed <- sum(us_daily$Confirmed)
us_recovered <- sum(us_daily$Recovered)
us_deaths <- sum(us_daily$Deaths)
us_active <- us_confirmed - us_recovered - us_deaths

us_cases <-
  data.frame(
    id = rep("cases", 3),
    cases = c(us_active, us_recovered, us_deaths),
    type = factor(
      1:3,
      levels = 1:3,
      labels = c("active", "recovered", "deaths")
    ),
    stringsAsFactors = F
  )
```

```{r world, include=FALSE}
world_ts <-
  data.frame(
    date = as.Date(names(ts_confirmed), format = "X%m.%e.%y")[-(1:4)],
    cases = colSums(ts_confirmed[, -(1:4)], na.rm = T),
    deaths = colSums(ts_deaths[, -(1:4)], na.rm = T)
  )

wrld_new_cases <-
  world_ts$cases[-1] - world_ts$cases[-nrow(world_ts)]
wrld_by_day <-
  world_ts$cases[-1] / world_ts$cases[-nrow(world_ts)]
wrld_growth_rate <- wrld_new_cases[-1] / wrld_new_cases[-length(wrld_new_cases)]
wrld_growth_data <- data.frame(
  date = world_ts$date[-(1:2)],
  cases = world_ts$cases[-(1:2)],
  change_cases = wrld_by_day[-1],
  new_cases = wrld_new_cases[-1],
  change_new = wrld_growth_rate
)
rm(wrld_new_cases, wrld_by_day, wrld_growth_rate)
wrld_growth_data$change_new[is.infinite(us_growth_data$change_new)] <- 0
wrld_growth_data$change_new[is.nan(us_growth_data$change_new)] <- 0


wrld_confirmed <- sum(daily_update$Confirmed)
wrld_recovered <- sum(daily_update$Recovered)
wrld_deaths <- sum(daily_update$Deaths)
wrld_active <- wrld_confirmed - wrld_recovered - wrld_deaths

wrld_cases <-
  data.frame(
    id = rep("cases", 3),
    cases = c(wrld_active, wrld_recovered, wrld_deaths),
    type = factor(
      1:3,
      levels = 1:3,
      labels = c("active", "recovered", "deaths")
    ),
    stringsAsFactors = F
  )
```

This report was last updated on `r Sys.Date()`.

Data collected by [JHU CSSE](https://systems.jhu.edu/research/public-health/ncov/). See also the [COVID Tracking Project](https://covidtracking.com/).

<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101237072);</script>
<script async src="//static.getclicky.com/js"></script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101237072ns.gif" /></p></noscript>

# Overview {.tabset .tabset-fade .tabset-pills}

## United States

**Recovery data is not currently available for the United States.**

**Cases:** `r prettyNum(us_confirmed, big.mark = ",")`

**Active:** `r prettyNum(us_active, big.mark = ",")` (`r round(100 * us_active/us_confirmed, 1)`%)

**Recovered:** `r prettyNum(us_recovered, big.mark = ",")` (`r round(100 * us_recovered/us_confirmed, 1)`%)

**Deaths:** `r prettyNum(us_deaths, big.mark = ",")` (`r round(100 * us_deaths/us_confirmed, 1)`%)

``` {r us:bar}
ggplot(data = us_cases, aes(x = type, y = cases, fill = type)) +
  geom_bar(stat = "identity") +
  scale_x_discrete(name = "", expand = c(0, 0)) +
  scale_y_continuous("Cases", n.breaks = 10, expand = c(0, 0)) +
  scale_fill_manual(values = c("darkorange", "forestgreen", "firebrick1"),
                    guide = FALSE) +
  theme_dark
```


## Global

**Cases:** `r prettyNum(wrld_confirmed, big.mark = ",")`

**Active:** `r prettyNum(wrld_active, big.mark = ",")` (`r round(100 * wrld_active/wrld_confirmed, 1)`%)

**Recovered:** `r prettyNum(wrld_recovered, big.mark = ",")` (`r round(100 * wrld_recovered/wrld_confirmed, 1)`%)

**Deaths:** `r prettyNum(wrld_deaths, big.mark = ",")` (`r round(100 * wrld_deaths/wrld_confirmed, 1)`%)

``` {r wrld:bar}
ggplot(data = wrld_cases, aes(x = type, y = cases, fill = type)) +
  geom_bar(stat = "identity") +
  scale_x_discrete(name = "", expand = c(0, 0)) +
  scale_y_continuous("Cases", n.breaks = 10, expand = c(0, 0)) +
  scale_fill_manual(values = c("darkorange", "forestgreen", "firebrick1"),
                    guide = FALSE) +
  theme_dark
```


# Case Map {.tabset .tabset-fade .tabset-pills}

## United States

```{r us:map}
dmn <- c(min(log(us_map$Confirmed[us_map$Confirmed > 0]), na.rm = T), 
            max(log(us_map$Confirmed[us_map$Confirmed > 0]), na.rm = T))

pal <-
  colorNumeric(palette = "YlOrRd",
               domain = dmn,
               na.color = "white")

lab_choro <- paste0(
  "<strong>",
  us_map$Admin2,
  ifelse(us_map$Admin2 == "", "", ", "),
  us_map$Province_State,
  "</strong><br>",
  prettyNum(us_map$Confirmed , big.mark = ","),
  " cases<br>",
  prettyNum(us_map$Deaths, big.mark = ","),
  " deaths"
) %>%
  lapply(htmltools::HTML)

lab_circle <- paste0(
  "<strong>",
  us_daily$Admin2,
  ifelse(us_daily$Admin2 == "", "", ", "),
  us_daily$Province_State,
  "</strong><br>",
  prettyNum(us_daily$Confirmed , big.mark = ","),
  " cases<br>",
  prettyNum(us_daily$Deaths, big.mark = ","),
  " deaths"
) %>%
  lapply(htmltools::HTML)

leaflet(us_map) %>%
  addProviderTiles(providers$Stamen.Toner) %>%
  addPolygons(
    fillColor = ~ pal(log(Confirmed)),
    weight = 1,
    opacity = 1,
    color = "#000000",
    fillOpacity = 1,
    smoothFactor = 0.5,
    highlight = highlightOptions(
      weight = 3,
      color = "white",
      bringToFront = T,
      sendToBack = T
    ),
    label = lab_choro,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    group = "Choropleth"
  ) %>%
  addCircleMarkers(
    lng = us_daily$Long_,
    lat = us_daily$Lat,
    label = lab_circle,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    radius = log(us_daily$Confirmed),
    weight = 10,
    fillColor = "red",
    stroke = F,
    group = "Markers"
  ) %>%
  addLayersControl(
    baseGroups = c("Choropleth", "Markers"),
    options = layersControlOptions(collapsed = F, autoZIndex = T)
  )  %>%
  setView(lat =  39.8333333,
          lng = -98.585522,
          zoom = 4)
```

## Global

```{r world:map}
lab <- paste0(
  "<strong>",
  daily_update$Country_Region,
  ifelse(daily_update$Province_State == "", "", ": "),
  daily_update$Admin2,
  ifelse(daily_update$Admin2 == "", "", ", "),
  daily_update$Province_State,
  "</strong><br>",
  prettyNum(daily_update$Confirmed , big.mark = ","),
  " cases<br>",
  prettyNum(daily_update$Deaths, big.mark = ","),
  " deaths"
) %>%
  lapply(htmltools::HTML)

leaflet(daily_update) %>%
  addProviderTiles(providers$Stamen.Toner) %>%
  addCircleMarkers(
    lng = daily_update$Long_,
    lat = daily_update$Lat,
    label = lab,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    radius = log(daily_update$Confirmed),
    weight = 10,
    fillColor = "red",
    stroke = F
  )
```

# Cumulative Cases 

## Linear Scale {.tabset .tabset-fade .tabset-pills}

### United States

The cumulative number of cases doesn't tell us much -- it's not possible for this number to go down. We can see that the growth seems to be accelerating, but we will look closer in the next chart.

```{r us:total}
ggplot(us_ts, aes(x = date, y = cases)) +
  geom_point(color = "red", aes(y = 20 * deaths)) +
  geom_line(color = "red", aes(y = 20 * deaths)) +
  geom_smooth(method = "loess", formula = y ~ x) +
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    name = "Cases",
    n.breaks = 10,
    sec.axis = sec_axis(~ . / 20, name = "Deaths")
  ) +
  theme_dark
```

### Global

```{r world:total}
ggplot(world_ts, aes(x = date, y = cases)) +
  geom_smooth(method = "loess", formula = y ~ x) +
  geom_point(color = "red", aes(y = 20 * deaths)) +
  geom_line(color = "red", aes(y = 20 * deaths)) +
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    name = "Cases",
    n.breaks = 10,
    sec.axis = sec_axis( ~ . / 20, name = "Deaths")
  ) +
  theme_dark
```


## Log Scale {.tabset .tabset-fade .tabset-pills}

### United States

An OLS fit to the logged values shows how closely the pandemic mimics an exponential curve. (All pandemics are modeled as a logistic function since there is a ceiling to the number of infected individuals, but in the growth phase, we can model them as exponential.) If the rate of growth were slowing, points would begin to appear below the fit line. The second line (orange) is fit only only to March, once testing ramped up in the US -- note the narrower confidence bands.

```{r us:logged}
ggplot(us_ts, aes(x = date, y = cases)) +
  geom_smooth(method = "lm", formula = y ~ x) +
  geom_smooth(
    data = subset(us_ts, us_ts$date > "2020-02-29"),
    aes(x = date, y = cases),
    method = "lm",
    formula = y ~ x,
    color = "darkorange",
    fullrange = T
  ) +
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    name = "Cases",
    n.breaks = 10,
    trans = "log10",
    limits = c(0.8, NA)
  ) +
  theme_dark
```

### Global

```{r world:logged}
ggplot(world_ts, aes(x = date, y = cases)) +
  geom_smooth(method = "lm", formula = y ~ x) +
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date",
               date_breaks = "1 week",
               date_labels = "%b %e") +
  scale_y_continuous(
    "Cases",
    n.breaks = 10,
    trans = "log10"
  ) +
  theme_dark
```

# Growth Rate

## New Cases by Day {.tabset .tabset-fade .tabset-pills}

### United States

This is the famed curve that needs to be flattened so we don't overwhelm our medical capacity on the first wave of the pandemic. As you can see, we are still climbing. 

```{r us:newcases}
ggplot(us_growth_data, aes(x = date, y = new_cases)) +
  geom_smooth(method = "loess", formula = y ~ x) + 
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%b %e") +
  scale_y_continuous("New Cases", n.breaks = 10) +
  theme_dark
```

### Global

```{r world:newcases}
ggplot(wrld_growth_data, aes(x = date, y = new_cases)) +
  geom_smooth(method = "loess", formula = y ~ x) + 
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%b %e") +
  scale_y_continuous("New Cases", n.breaks = 10) +
  #ggtitle("New Cases by Day on Earth") +
  theme_dark
```

## Rate of Change in New Cases {.tabset .tabset-fade .tabset-pills}

### United States

Now, let's see the y-axis with the new cases as a multiple of the number of new cases the previous day. This is akin to the second derivative of the growth function. We want this to approach 0 as we flatten the curve.

```{r us:growth}
ggplot(us_growth_data, aes(x = date, y = change_new)) +
  geom_smooth(method = "loess", formula = y ~ x) +
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%b %e") +
  scale_y_continuous("∂ New Cases", n.breaks = 10) +
  #ggtitle("Change in New Cases by Day in the US") +
  theme_dark
```

### Global

```{r world:growth}
ggplot(wrld_growth_data, aes(x = date, y = change_new)) +
  geom_smooth(method = "loess", formula = y ~ x) +
  geom_point(color = "white") +
  geom_line(color = "white") +
  scale_x_date(name = "Date", date_breaks = "1 week", date_labels = "%b %e") +
  scale_y_continuous("∂ New Cases", n.breaks = 10) +
  #ggtitle("Change in New Cases by Day on Earth") +
  theme_dark
```

# Table {.tabset .tabset-fade .tabset-pills}

## United States
```{r us:table}
out <- us_growth_data[us_growth_data$date > "2020-02-29",]
out$cases <- prettyNum(out$cases, big.mark = ",")
out$new_cases <- prettyNum(out$new_cases, big.mark = ",")
kable(
  out,
  col.names = c("Date", "Cases", "∂ Cases", "New Cases", "∂ New Cases"),
  row.names = F,
  align = "lllll",
  digits = 3
) %>%
  kable_styling(bootstrap_options = c("hover")) %>%
  column_spec(1, bold = T)
```

## Global

```{r world:table}
out <- wrld_growth_data[wrld_growth_data$date > "2020-02-29",]
out$cases <- prettyNum(out$cases, big.mark = ",")
out$new_cases <- prettyNum(out$new_cases, big.mark = ",")
kable(
  out,
  col.names = c("Date", "Cases", "∂ Cases", "New Cases", "∂ New Cases"),
  row.names = F,
  align = "lllll",
  digits = 3
) %>% 
  kable_styling(bootstrap_options = c("hover")) %>%
  column_spec(1, bold = T)
```

